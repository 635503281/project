user nginx www;
worker_processes  2;

error_log  {{ conf.env("KAE_APP_LOG_DIR") }}/{{ conf.env("KAE_APP_NAME") }}-error.log  error;
pid  /var/run/nginx.pid;

events {
  use epoll;
  worker_connections  65535;
  accept_mutex off;
}

http {
  include       mime.types;
  default_type  text/html;
  charset utf-8;

  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" $request_time $upstream_response_time';

  log_format  proxy '$http_x_real_ip - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" $request_time $upstream_response_time';

  log_format json '{"@timestamp":"$time_iso8601",'
              '"remote_addr":"$remote_addr",'
              '"request":"$request",'
              '"status":$status,'
              '"body_bytes":$body_bytes_sent,'
              '"user_agent":"$http_user_agent",'
              '"resp_time":"$upstream_response_time",'
              '"req_time":$request_time,'
              '"host":"$host",'
              '"http_x_forwarded_for":"$http_x_forwarded_for",'
              '"upstream_addr":"$upstream_addr"}';
  #access_log  logs/access.log json;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;

  keepalive_timeout  30;

  gzip  on;
  gzip_static on;
  gzip_http_version 1.0;
  gzip_disable "MSIE [1-6]\.";
  gzip_vary on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_buffers 4 32k;
  gzip_types text/plain application/json application/x-javascript application/javascript text/css;

  client_max_body_size 100M;
  client_body_buffer_size  256k;
  large_client_header_buffers 4 128k;
  client_header_buffer_size 32k;

  proxy_cache_path /dev/shm/proxy_cache levels=1:2 keys_zone=proxy_cache_one:1024m;

  include vhost/*.conf;
}